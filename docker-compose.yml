name: mcp-gateway-demo

services:
  # Local IdentityServer (OAuth 2.1 / OpenID Connect Provider)
  idp:
    build:
      context: ./idp/IdentityServer
      dockerfile: Dockerfile
    pull_policy: build
    image: mcp-idp:latest
    container_name: mcp-idp
    restart: unless-stopped
    ports:
      - "5001:5000"
    volumes:
      - idp-data:/data
    environment:
      ASPNETCORE_URLS: http://+:5000
      ASPNETCORE_ENVIRONMENT: Development
    networks:
      - mcp-demo-network
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:5000/.well-known/openid-configuration"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

  # MCP Gateway (AgentGateway)
  # https://agentgateway.dev/
  mcp-gateway:
    image: ghcr.io/agentgateway/agentgateway:latest
    container_name: mcp-gateway
    restart: unless-stopped
    ports:
      - "3000:3000"    # MCP endpoint
      - "3001:3001"    # Admin UI
    volumes:
      - ./gateway/config.yaml:/etc/agentgateway/config.yaml:ro
      - ./gateway/petstore-openapi.json:/etc/agentgateway/petstore-openapi.json:ro
    command: ["-f", "/etc/agentgateway/config.yaml"]
    depends_on:
      idp:
        condition: service_healthy
    networks:
      - mcp-demo-network
    # Note: AgentGateway uses a minimal container without curl/wget/sh
    # Healthcheck disabled - the binary is stable and restarts on failure
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M

  # OAuth2 Proxy (SSO sidecar for Admin UI)
  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:v7.7.1
    container_name: mcp-oauth2-proxy
    restart: unless-stopped
    command:
      - --http-address=0.0.0.0:4180
      - --provider=oidc
      - --client-id=gateway-admin-ui
      - --client-secret=gateway-admin-secret
      - --redirect-url=https://gateway-ui.localhost:8080/oauth2/callback
      - --skip-oidc-discovery=true
      - --login-url=https://idp.localhost:8080/connect/authorize
      - --redeem-url=http://idp:5000/connect/token
      - --oidc-jwks-url=http://idp:5000/.well-known/openid-configuration/jwks
      - --profile-url=http://idp:5000/connect/userinfo
      - --oidc-issuer-url=https://idp.localhost:8080
      - --ssl-insecure-skip-verify=true
      - --email-domain=*
      - --reverse-proxy=true
      - --set-xauthrequest=true
      - --skip-provider-button=true
      - --cookie-name=_oauth2_proxy
      - --cookie-domain=gateway-ui.localhost
      - --cookie-secure=true
      - --cookie-samesite=lax
      - --cookie-secret=0123456789abcdef0123456789abcdef
      - --scope=openid profile email
    depends_on:
      idp:
        condition: service_healthy
    networks:
      - mcp-demo-network
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 64M

  # Nginx Reverse Proxy
  nginx:
    image: nginx:1.27-alpine
    container_name: mcp-nginx
    restart: unless-stopped
    ports:
      - "8080:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./nginx/snippets:/etc/nginx/snippets:ro
      - ./nginx/certs:/etc/nginx/certs:ro
    depends_on:
      idp:
        condition: service_healthy
      mcp-gateway:
        condition: service_started
      oauth2-proxy:
        condition: service_started
      jsonplaceholder-mcp:
        condition: service_healthy
      weather-mcp:
        condition: service_healthy
      mcp-inspector:
        condition: service_healthy
    networks:
      - mcp-demo-network
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider --no-check-certificate https://localhost/health || exit 0"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 128M

  # JSONPlaceholder MCP Server
  jsonplaceholder-mcp:
    build:
      context: ./mcp-servers/jsonplaceholder
      dockerfile: Dockerfile
    image: mcp-jsonplaceholder:latest
    container_name: jsonplaceholder-mcp
    restart: unless-stopped
    ports:
      - "8001:8001"
    environment:
      MCP_TRANSPORT: streamable-http
      MCP_PORT: 8001
      MCP_HOST: 0.0.0.0
      PYTHONDONTWRITEBYTECODE: 1
      PYTHONUNBUFFERED: 1
    networks:
      - mcp-demo-network
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import socket; s=socket.socket(); s.settimeout(5); s.connect(('localhost',8001)); s.close()\""]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

  # Weather MCP Server
  weather-mcp:
    build:
      context: ./mcp-servers/weather
      dockerfile: Dockerfile
    image: mcp-weather:latest
    container_name: weather-mcp
    restart: unless-stopped
    ports:
      - "8002:8002"
    environment:
      MCP_TRANSPORT: streamable-http
      MCP_PORT: 8002
      MCP_HOST: 0.0.0.0
      # Set OPENWEATHERMAP_API_KEY for real weather data
      # Without it, the server returns mock data for demo purposes
      OPENWEATHERMAP_API_KEY: ${OPENWEATHERMAP_API_KEY:-}
      PYTHONDONTWRITEBYTECODE: 1
      PYTHONUNBUFFERED: 1
    networks:
      - mcp-demo-network
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import socket; s=socket.socket(); s.settimeout(5); s.connect(('localhost',8002)); s.close()\""]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

  # MCP Inspector
  mcp-inspector:
    image: ghcr.io/modelcontextprotocol/inspector:latest
    container_name: mcp-inspector
    restart: unless-stopped
    ports:
      - "6274:6274"    # Client UI
      - "6277:6277"    # Proxy server
    environment:
      HOST: 0.0.0.0
      MCP_AUTO_OPEN_ENABLED: "false"
      # Accept self-signed certificates from nginx (dev only)
      NODE_TLS_REJECT_UNAUTHORIZED: "0"
    networks:
      - mcp-demo-network
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://localhost:6274',(r)=>{process.exit(r.statusCode===200?0:1)}).on('error',()=>process.exit(1))\""]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

volumes:
  idp-data:

networks:
  mcp-demo-network:
    name: mcp-demo-network
    driver: bridge
