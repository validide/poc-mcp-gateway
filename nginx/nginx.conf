server {
    listen 80;
    server_name localhost;

    # RFC 9728 compliant path rewriting for OAuth metadata discovery
    # FROM: /.well-known/oauth-protected-resource/servers/{SERVER_ID}[/mcp]
    # TO:   /servers/{SERVER_ID}/.well-known/oauth-protected-resource
    location ~ ^/\.well-known/oauth-protected-resource/servers/(.+) {
        # Disable caching
        proxy_no_cache 1;
        proxy_cache_bypass 1;
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
        add_header Pragma "no-cache" always;
        expires off;

        proxy_set_header Host localhost:4444;
        proxy_set_header X-Forwarded-Host localhost:4444;
        proxy_set_header X-Forwarded-Proto http;
        rewrite ^/\.well-known/oauth-protected-resource/servers/([^/]+)(/mcp)?$ /servers/$1/.well-known/oauth-protected-resource break;
        proxy_pass http://mcp-gateway:4444;
    }

    # Everything else passes through unchanged
    location / {
        proxy_set_header Host localhost:4444;
        proxy_pass http://mcp-gateway:4444;
    }
}
